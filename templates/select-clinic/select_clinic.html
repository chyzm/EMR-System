{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="min-h-screen bg-gray-50 px-4 py-10">
  <div class="max-w-7xl mx-auto">

    {% if clinics_enriched %}
      {% if has_multiple_clinics %}
        <!-- Header -->
        <div class="text-center mb-8">
          <h2 class="text-3xl font-bold text-gray-900">Select Clinic</h2>
          <p class="text-gray-600">Search or filter if you belong to many clinics.</p>
        </div>

        <!-- Toolbar (shown only if > 1 clinic) -->
        <div class="mx-auto max-w-5xl mb-8 flex flex-col sm:flex-row items-stretch sm:items-center gap-3">
          <div class="flex-1">
            <input id="clinic-search" type="text" placeholder="Search clinics by name or type..."
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                   autocomplete="off">
          </div>
          <div class="flex gap-2">
            <button data-filter="all"
                    class="filter-btn px-4 py-2 rounded-lg border text-sm font-semibold bg-white text-gray-700 border-gray-300">
              All ({{ clinics_enriched|length }})
            </button>
            <button data-filter="active"
                    class="filter-btn px-4 py-2 rounded-lg border text-sm font-semibold bg-white text-green-700 border-green-300">
              Active ({{ active_count }})
            </button>
            <button data-filter="expired"
                    class="filter-btn px-4 py-2 rounded-lg border text-sm font-semibold bg-white text-red-700 border-red-300">
              Expired ({{ expired_count }})
            </button>
          </div>
        </div>

        <!-- Grid -->
        <div id="clinic-grid" class="mx-auto max-w-6xl grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 justify-center">
          {% for item in clinics_enriched %}
            {% with clinic=item.clinic %}
            <div class="clinic-card w-full max-w-sm mx-auto bg-white rounded-xl shadow border border-gray-200 p-6"
                 data-name="{{ clinic.name|lower }} {{ clinic.get_clinic_type_display|lower }}"
                 data-status="{% if item.is_expired %}expired{% else %}active{% endif %}">
              <div class="flex items-center justify-between mb-3">
                <h3 class="text-lg font-semibold text-gray-900">{{ clinic.name }}</h3>
                <span class="inline-block px-2 py-1 rounded text-xs
                    {% if item.is_expired %}bg-red-100 text-red-800{% else %}bg-green-100 text-green-800{% endif %}">
                  {% if item.is_expired %}Expired{% else %}Active{% endif %}
                </span>
              </div>
              <p class="text-sm text-gray-600 mb-2">Type: {{ clinic.get_clinic_type_display }}</p>
              <div class="mb-4 p-3 bg-gray-50 rounded border border-gray-100">
                {% if clinic.subscription_end_date %}
                  <p class="text-sm text-gray-700">
                    Expires: <span class="font-medium">{{ clinic.subscription_end_date }}</span>
                    {% if item.days_left is not None and item.days_left >= 0 %}
                      • <span class="text-blue-600 font-semibold">{{ item.days_left }} day{{ item.days_left|pluralize }} left</span>
                    {% endif %}
                  </p>
                {% else %}
                  <p class="text-sm text-red-600 font-semibold">No active subscription</p>
                {% endif %}
              </div>

              {% if item.is_expired %}
                {% if item.can_renew %}
                  <div class="space-y-2">
                    <a href="{{ item.renew_monthly_url }}"
                       class="block w-full text-center py-2 rounded-lg font-semibold bg-blue-900 text-white hover:bg-blue-800 transition">
                      Renew Monthly (₦15,000)
                    </a>
                    <a href="{{ item.renew_yearly_url }}"
                       class="block w-full text-center py-2 rounded-lg font-semibold bg-white text-blue-900 border border-blue-900 hover:bg-blue-50 transition">
                      Renew Yearly (₦150,000)
                    </a>
                  </div>
                {% else %}
                  <p class="text-center text-sm text-gray-600">Contact your clinic admin to renew.</p>
                {% endif %}
              {% else %}
                <form method="post" class="mt-2">
                  {% csrf_token %}
                  <input type="hidden" name="clinic_id" value="{{ clinic.id }}">
                  <button type="submit"
                          class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 rounded-lg">
                    Use this clinic
                  </button>
                </form>
              {% endif %}
            </div>
            {% endwith %}
          {% endfor %}
        </div>

        <p id="no-results" class="hidden text-center text-gray-500 mt-8">No clinics match your filters.</p>

      {% else %}
        <!-- Single clinic card (no filters/search shown) -->
        {% with item=single_clinic clinic=single_clinic.clinic %}
        <div class="min-h-[60vh] flex items-center justify-center">
          <div class="w-full max-w-md mx-auto bg-white rounded-xl shadow border border-gray-200 p-6">
            <h3 class="text-xl font-bold text-center text-gray-900">{{ clinic.name }}</h3>
            <p class="text-sm text-gray-600 text-center mt-1">Type: {{ clinic.get_clinic_type_display }}</p>
            <div class="mt-4 p-3 bg-gray-50 rounded border border-gray-100 text-center">
              {% if clinic.subscription_end_date %}
                <p class="text-sm text-gray-700">
                  Expires: <span class="font-medium">{{ clinic.subscription_end_date }}</span>
                  {% if item.days_left is not None and item.days_left >= 0 %}
                    • <span class="text-blue-600 font-semibold">{{ item.days_left }} day{{ item.days_left|pluralize }} left</span>
                  {% endif %}
                </p>
              {% else %}
                <p class="text-sm text-red-600 font-semibold">No active subscription</p>
              {% endif %}
            </div>

            {% if item.is_expired %}
              {% if item.can_renew %}
                <div class="mt-5 space-y-2">
                  <a href="{{ item.renew_monthly_url }}" class="block w-full text-center py-2 rounded-lg font-semibold bg-blue-900 text-white hover:bg-blue-800">Renew Monthly (₦15,000)</a>
                  <a href="{{ item.renew_yearly_url }}" class="block w-full text-center py-2 rounded-lg font-semibold bg-white text-blue-900 border border-blue-900 hover:bg-blue-50">Renew Yearly (₦150,000)</a>
                </div>
              {% else %}
                <p class="mt-4 text-sm text-gray-600 text-center">Contact your clinic admin to renew.</p>
              {% endif %}
            {% else %}
              <form method="post" class="mt-5">
                {% csrf_token %}
                <input type="hidden" name="clinic_id" value="{{ clinic.id }}">
                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 rounded-lg">Use this clinic</button>
              </form>
            {% endif %}
          </div>
        </div>
        {% endwith %}
      {% endif %}

    {% else %}
      <!-- Fallback: no clinics data -->
      <div class="min-h-[60vh] flex items-center justify-center">
        <p class="text-gray-600">No clinics available.</p>
      </div>
    {% endif %}
  </div>
</div>

{% if has_multiple_clinics %}
<script>
  (function() {
    const search = document.getElementById('clinic-search');
    const buttons = document.querySelectorAll('.filter-btn');
    const cards = document.querySelectorAll('.clinic-card');
    const noResults = document.getElementById('no-results');
    let filter = 'all';

    function apply() {
      const q = (search?.value || '').trim().toLowerCase();
      let visible = 0;
      cards.forEach(card => {
        const name = card.getAttribute('data-name');
        const status = card.getAttribute('data-status'); // active|expired
        const matchText = !q || name.includes(q);
        const matchFilter = filter === 'all' || status === filter;
        const show = matchText && matchFilter;
        card.classList.toggle('hidden', !show);
        if (show) visible++;
      });
      if (noResults) noResults.classList.toggle('hidden', visible !== 0);
    }

    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        buttons.forEach(b => b.classList.remove('ring-2','ring-blue-500'));
        btn.classList.add('ring-2','ring-blue-500');
        filter = btn.dataset.filter;
        apply();
      });
    });

    if (search) search.addEventListener('input', apply);
  })();
</script>
{% endif %}
{% endblock %}






{% comment %} {% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-md mx-auto bg-white rounded-lg shadow-md overflow-hidden">
        <div class="bg-blue-600 py-4 px-6">
            <h2 class="text-white text-xl font-semibold">Select Clinic</h2>
        </div>
        <div class="p-6">
            <form method="post">
                {% csrf_token %}
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="clinic_id">
                        Select Clinic to Work In:
                    </label>
                    <select name="clinic_id" id="clinic_id" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <option value="">-- Select Clinic --</option>
                        {% for clinic in clinics %}
                            <option value="{{ clinic.id }}">
                                {{ clinic.get_clinic_type_display }} - {{ clinic.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mt-6">
                    <button type="submit" 
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                        Continue
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %} {% endcomment %}